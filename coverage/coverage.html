<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
        body {
            background: black;
            color: rgb(80, 80, 80);
        }

        body, pre, #legend span {
            font-family: Menlo, monospace;
            font-weight: bold;
        }

        #topbar {
            background: black;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 42px;
            border-bottom: 1px solid rgb(80, 80, 80);
        }

        #content {
            margin-top: 50px;
        }

        #nav, #legend {
            float: left;
            margin-left: 10px;
        }

        #legend {
            margin-top: 12px;
        }

        #nav {
            margin-top: 10px;
        }

        #legend span {
            margin: 0 5px;
        }

        .cov0 {
            color: rgb(192, 0, 0)
        }

        .cov1 {
            color: rgb(128, 128, 128)
        }

        .cov2 {
            color: rgb(116, 140, 131)
        }

        .cov3 {
            color: rgb(104, 152, 134)
        }

        .cov4 {
            color: rgb(92, 164, 137)
        }

        .cov5 {
            color: rgb(80, 176, 140)
        }

        .cov6 {
            color: rgb(68, 188, 143)
        }

        .cov7 {
            color: rgb(56, 200, 146)
        }

        .cov8 {
            color: rgb(44, 212, 149)
        }

        .cov9 {
            color: rgb(32, 224, 152)
        }

        .cov10 {
            color: rgb(20, 236, 155)
        }

    </style>
</head>
<body>
<div id="topbar">
    <div id="nav">
        <select id="files">

            <option value="file0">SimpleCRUDApp/app.go (56.2%)</option>

            <option value="file1">SimpleCRUDApp/main.go (55.6%)</option>

            <option value="file2">SimpleCRUDApp/responses.go (83.3%)</option>

        </select>
    </div>
    <div id="legend">
        <span>not tracked</span>

        <span class="cov0">not covered</span>
        <span class="cov8">covered</span>

    </div>
</div>
<div id="content">
		
		<pre class="file" id="file0" style="display: none">/*
 * Copyright (C) 2019  Murat Koptur
 *
 * Contact: mkoptur3@gmail.com
 *
 * Last edit: 3/30/19 10:21 PM
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 */

package main

import (
        "database/sql"
        "encoding/json"
        _ "github.com/go-sql-driver/mysql"
        "github.com/gorilla/mux"
        "github.com/spf13/viper"
        "log"
        "net/http"
        "strconv"
)

type App struct {
        Router *mux.Router
        DB     *sql.DB
}

// curl 127.0.0.1:8000/api/products/list
func (a *App) getProducts(w http.ResponseWriter, r *http.Request) <span class="cov0" title="0">{
        rows, err := a.DB.Query("SELECT * FROM products")
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusInternalServerError, err.Error())
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var products []Product
        for rows.Next() </span><span class="cov0" title="0">{
                var p Product
                err := rows.Scan(&amp;p.Id, &amp;p.Name, &amp;p.Manufacturer)
                if err != nil </span><span class="cov0" title="0">{
                        respondWithError(w, http.StatusInternalServerError, err.Error())
                }</span>

                <span class="cov0" title="0">products = append(products, p)</span>
        }

        <span class="cov0" title="0">_ = json.NewEncoder(w).Encode(products)</span>
}

// curl --header "Content-Type: application/json" --request POST --data '{"name": "ABC", "manufacturer": "ACME"}' \
//                 127.0.0.1:8000/api/products/new
func (a *App) createProduct(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        var p Product
        decoder := json.NewDecoder(r.Body)
        if err := decoder.Decode(&amp;p); err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, "Invalid payload")
                return
        }</span>
        <span class="cov8" title="1">defer r.Body.Close()

        _, err := a.DB.Query("INSERT INTO products (name, manufacturer) VALUES (?, ?)", p.Name, p.Manufacturer)
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusInternalServerError, err.Error())
                return
        }</span>

        <span class="cov8" title="1">respondWithMessage(w, http.StatusCreated, "New row added.")</span>
}

// curl 127.0.0.1:8000/api/products/10
func (a *App) getProduct(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        vars := mux.Vars(r)
        id, err := strconv.Atoi(vars["id"])
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, "Invalid product ID")
                return
        }</span>

        <span class="cov8" title="1">p := Product{Id: id}
        row := a.DB.QueryRow("SELECT name, manufacturer FROM products WHERE id=?", p.Id)
        if err := row.Scan(&amp;p.Name, &amp;p.Manufacturer); err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, err.Error())
                return
        }</span>

        <span class="cov8" title="1">respondWithJSON(w, http.StatusOK, p)</span>
}

// curl --request PUT --data '{"name": "ABC", "manufacturer": "ACME"}' 127.0.0.1:8000/api/products/11
func (a *App) updateProduct(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        vars := mux.Vars(r)
        id, err := strconv.Atoi(vars["id"])
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, "Invalid product ID")
                return
        }</span>

        <span class="cov8" title="1">var p Product
        decoder := json.NewDecoder(r.Body)
        if err := decoder.Decode(&amp;p); err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, "Invalid payload")
                return
        }</span>
        <span class="cov8" title="1">defer r.Body.Close()
        p.Id = id

        _, err = a.DB.Query("UPDATE products SET name=?, manufacturer=? WHERE id=?", p.Name, p.Manufacturer, p.Id)
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusInternalServerError, err.Error())
                return
        }</span>

        <span class="cov8" title="1">respondWithJSON(w, http.StatusOK, p)</span>
}

// curl --request DELETE 127.0.0.1:8000/api/products/10
func (a *App) deleteProduct(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        vars := mux.Vars(r)
        id, err := strconv.Atoi(vars["id"])
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusBadRequest, "Invalid product ID")
                return
        }</span>

        <span class="cov8" title="1">_, err = a.DB.Query("DELETE FROM products WHERE id=?", id)
        if err != nil </span><span class="cov0" title="0">{
                respondWithError(w, http.StatusInternalServerError, err.Error())
                return
        }</span>

        <span class="cov8" title="1">respondWithMessage(w, http.StatusOK, "Deleted.")</span>
}

func (a *App) InitializeRoutes() <span class="cov8" title="1">{
        a.Router.HandleFunc("/api/products/list", a.getProducts).Methods("GET")
        a.Router.HandleFunc("/api/products/new", a.createProduct).Methods("POST")
        a.Router.HandleFunc("/api/products/{id:[0-9]+}", a.getProduct).Methods("GET")
        a.Router.HandleFunc("/api/products/{id:[0-9]+}", a.updateProduct).Methods("PUT")
        a.Router.HandleFunc("/api/products/{id:[0-9]+}", a.deleteProduct).Methods("DELETE")
}</span>

func (a *App) Initialize(username, password, server, port, dbName string) <span class="cov8" title="1">{
        dataSource := username + ":" + password + "@tcp(" + server + ":" + port + ")/" + dbName
        a.DB, err = sql.Open("mysql", dataSource)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatal(err)
        }</span>

        <span class="cov8" title="1">a.Router = mux.NewRouter()
        a.InitializeRoutes()</span>
}

func (a *App) Run(addr string) <span class="cov0" title="0">{
        log.Fatal(http.ListenAndServe(":"+viper.GetString("Server.port"), a.Router))
}</span>
</pre>

    <pre class="file" id="file1" style="display: none">/*
 * Copyright (C) 2019  muratkoptur
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 */

package main

import (
        "fmt"
        "github.com/spf13/viper"
)

var err error

func init() <span class="cov8" title="1">{
        viper.SetConfigName("config")
        viper.SetConfigType("toml")
        viper.AddConfigPath("./config/")
        err = viper.ReadInConfig()
        if err != nil </span><span class="cov0" title="0">{
                fmt.Println(err.Error())
        }</span>
}

func main() <span class="cov0" title="0">{
        a := App{}
        a.Initialize(viper.GetString("DB.username"),
                viper.GetString("DB.password"),
                viper.GetString("DB.server"),
                viper.GetString("DB.port"),
                viper.GetString("DB.db_name"))

        a.Run(viper.GetString("Server.port"))
}</span>
</pre>

    <pre class="file" id="file2" style="display: none">/*
 * Copyright (C) 2019  Murat Koptur
 *
 * Contact: mkoptur3@gmail.com
 *
 * Last edit: 3/30/19 10:21 PM
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 */

package main

import (
        "encoding/json"
        "net/http"
)

func respondWithJSON(w http.ResponseWriter, code int, payload interface{}) <span class="cov8" title="1">{
        response, _ := json.Marshal(payload)

        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(code)
        _, _ = w.Write(response)
}</span>

func respondWithMessage(w http.ResponseWriter, code int, message string) <span class="cov8" title="1">{
        respondWithJSON(w, code, map[string]string{"message": message})
}</span>

func respondWithError(w http.ResponseWriter, code int, message string) <span class="cov0" title="0">{
        respondWithJSON(w, code, map[string]string{"error": message})
}</span>
</pre>

</div>
</body>
<script>
    (function () {
        var files = document.getElementById('files');
        var visible;
        files.addEventListener('change', onChange, false);

        function select(part) {
            if (visible)
                visible.style.display = 'none';
            visible = document.getElementById(part);
            if (!visible)
                return;
            files.value = part;
            visible.style.display = 'block';
            location.hash = part;
        }

        function onChange() {
            select(files.value);
            window.scrollTo(0, 0);
        }

        if (location.hash != "") {
            select(location.hash.substr(1));
        }
        if (!visible) {
            select("file0");
        }
    })();
</script>
</html>
